import React, { useState, useEffect, useReducer, useCallback } from 'react';
import { initializeApp } from 'firebase/app';
import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from 'firebase/auth';
import { getFirestore, collection, doc, setDoc, onSnapshot, addDoc, updateDoc, deleteDoc } from 'firebase/firestore';
import {
  Home,
  LayoutGrid,
  DollarSign,
  ClipboardList,
  ChevronDown,
  Plus,
  Trash2,
  Check,
  Zap,
  HardHat,
  Monitor,
  Mic,
  FileText,
  Save,
  Loader2,
  Eye,
  Settings,
  Lightbulb
} from 'lucide-react';

// --- FIREBASE SETUP ---
const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-av-app';
const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

let app;
let db;
let auth;

try {
  if (Object.keys(firebaseConfig).length) {
    app = initializeApp(firebaseConfig);
    db = getFirestore(app);
    auth = getAuth(app);
  }
} catch (e) {
  console.error("Firebase initialization error:", e);
}

// --- INITIAL STATE AND REDUCER ---

const projectTemplate = {
  name: "New Client Project",
  status: 'Design Phase',
  design: {
    roomType: 'Dedicated Home Theater',
    roomDimensions: { length: 20, width: 14, height: 8 }, // ft
    seatingRows: 2,
    speakerLayout: '7.2.4 Dolby Atmos',
    notes: 'Prioritize bass management and wide sweet spot.',
  },
  equipment: [], // { name, model, clientPrice, yourCost, quantity }
  financials: {
    consultingFee: 1500, // Flat fee for design
    managementFeeRate: 0.10, // 10% of total equipment cost
    markupRateSubcontractor: 0.25, // 25% on installer labor
    markupRateCalibrator: 0.60, // 60% on calibration service
    subcontractorCost: 2000, // Estimate for contractor labor
    calibratorCost: 500, // Estimate for calibration service
  },
  workSpecs: {
    contractor: {
      tasks: 'Run all speaker wire; install 2 rows of risers; mount projector and screen structure.',
      requirements: 'Use licensed electrician for dedicated circuit.',
    },
    calibrator: {
      tasks: 'Full Audio EQ and Time Alignment; SDR/HDR/Dolby Vision Video Calibration.',
      requirements: 'Provide pre/post calibration report.',
    },
  },
};

const initialState = {
  userId: null,
  isAuthenticated: false,
  isAuthReady: false,
  projects: [],
  currentProject: null,
  activeTab: 'Design',
  isLoading: false,
  aiResponse: null, // New state for AI response data
  isAILoading: false, // New state for AI loading indicator
};

function appReducer(state, action) {
  switch (action.type) {
    case 'SET_AUTH_STATE':
      return { ...state, userId: action.payload.userId, isAuthenticated: action.payload.isAuthenticated, isAuthReady: true };
    case 'SET_LOADING':
      return { ...state, isLoading: action.payload };
    case 'SET_AI_RESPONSE':
      return { ...state, aiResponse: action.payload };
    case 'SET_AI_LOADING':
      return { ...state, isAILoading: action.payload };
    case 'SET_PROJECTS':
      return { ...state, projects: action.payload };
    case 'SET_CURRENT_PROJECT':
      return { ...state, currentProject: action.payload, activeTab: 'Design', aiResponse: null }; // Reset AI response on new project load
    case 'UPDATE_CURRENT_PROJECT':
      return { ...state, currentProject: action.payload };
    case 'SET_ACTIVE_TAB':
      return { ...state, activeTab: action.payload };
    default:
      return state;
  }
}

// --- UTILITY COMPONENTS ---

const Card = ({ children, className = '' }) => (
  <div className={`bg-white shadow-xl rounded-lg p-6 ${className}`}>
    {children}
  </div>
);

const Button = ({ children, onClick, disabled = false, icon: Icon, variant = 'primary', className = '' }) => {
  const baseStyle = 'flex items-center justify-center space-x-2 px-4 py-2 font-semibold rounded-lg transition duration-150 ease-in-out';
  let variantStyle = '';

  switch (variant) {
    case 'secondary':
      variantStyle = 'bg-gray-200 text-gray-800 hover:bg-gray-300';
      break;
    case 'danger':
      variantStyle = 'bg-red-500 text-white hover:bg-red-600';
      break;
    case 'success':
      variantStyle = 'bg-green-500 text-white hover:bg-green-600';
      break;
    case 'ghost':
      variantStyle = 'bg-transparent text-gray-700 hover:bg-gray-100 shadow-none';
      break;
    case 'primary':
    default:
      variantStyle = 'bg-blue-600 text-white hover:bg-blue-700 shadow-md';
      break;
  }

  return (
    <button
      onClick={onClick}
      disabled={disabled}
      className={`${baseStyle} ${variantStyle} ${disabled ? 'opacity-50 cursor-not-allowed' : ''} ${className}`}
    >
      {Icon && <Icon className="w-5 h-5" />}
      <span>{children}</span>
    </button>
  );
};

// --- CALCULATIONS ---

const calculateFinancials = (project) => {
  if (!project || !project.equipment || !project.financials) return null;

  const eqCosts = project.equipment.reduce((acc, eq) => ({
    clientTotal: acc.clientTotal + (eq.clientPrice * eq.quantity),
    yourTotal: acc.yourTotal + (eq.yourCost * eq.quantity),
  }), { clientTotal: 0, yourTotal: 0 });

  // 1. Core Revenue (Profit)
  const designFee = project.financials.consultingFee;
  const projectManagementFee = eqCosts.clientTotal * project.financials.managementFeeRate;

  // 2. Subcontractor Costs (COGS & Markup)
  const installerCost = project.financials.subcontractorCost;
  const calibratorCost = project.financials.calibratorCost;

  const installerMarkup = installerCost * project.financials.markupRateSubcontractor;
  const calibratorMarkup = calibratorCost * project.financials.markupRateCalibrator;

  const totalMarkup = installerMarkup + calibratorMarkup;
  const totalSubcontractorBill = installerCost + calibratorCost + totalMarkup;

  // 3. Final Invoice
  const totalClientInvoice = (
    eqCosts.clientTotal +
    designFee +
    projectManagementFee +
    totalSubcontractorBill
  );

  // 4. Final Profit
  const grossProfit = (
    designFee +
    projectManagementFee +
    totalMarkup
  );

  return {
    eqCosts,
    designFee,
    projectManagementFee,
    installerCost,
    calibratorCost,
    installerMarkup,
    calibratorMarkup,
    totalSubcontractorBill,
    totalClientInvoice,
    grossProfit,
  };
};

// --- FIREBASE CRUD FUNCTIONS ---

async function saveProjectToFirestore(project, userId, dispatch) {
  if (!db || !userId) return;
  dispatch({ type: 'SET_LOADING', payload: true });

  try {
    const projectRef = project.id 
      ? doc(db, 'artifacts', appId, 'users', userId, 'av_projects', project.id)
      : collection(db, 'artifacts', appId, 'users', userId, 'av_projects');

    const payload = {
      ...project,
      updatedAt: new Date().toISOString(),
      userId,
    };

    delete payload.id; // Firestore handles the ID

    if (project.id) {
      await setDoc(projectRef, payload);
    } else {
      const newDoc = await addDoc(projectRef, payload);
      payload.id = newDoc.id;
    }
    
    dispatch({ type: 'UPDATE_CURRENT_PROJECT', payload: payload });
    console.log("Project saved successfully.");

  } catch (e) {
    console.error("Error saving project:", e);
  } finally {
    dispatch({ type: 'SET_LOADING', payload: false });
  }
}

async function deleteProjectFromFirestore(projectId, userId, dispatch) {
  if (!db || !userId || !projectId) return;
  dispatch({ type: 'SET_LOADING', payload: true });

  try {
    const projectRef = doc(db, 'artifacts', appId, 'users', userId, 'av_projects', projectId);
    await deleteDoc(projectRef);
    console.log("Project deleted successfully.");
    dispatch({ type: 'SET_CURRENT_PROJECT', payload: null });
  } catch (e) {
    console.error("Error deleting project:", e);
  } finally {
    dispatch({ type: 'SET_LOADING', payload: false });
  }
}

// --- PROJECT EDITOR TAB COMPONENTS ---

// 1. Design & Room Specs
const DesignTab = ({ project, dispatch }) => {
  const updateDesign = (key, value) => {
    dispatch({
      type: 'UPDATE_CURRENT_PROJECT',
      payload: { ...project, design: { ...project.design, [key]: value } },
    });
  };

  return (
    <Card className="space-y-6">
      <h3 className="text-xl font-bold text-gray-800 flex items-center"><LayoutGrid className="w-5 h-5 mr-2" /> Room & Layout Details</h3>

      <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
        {/* Room Type */}
        <label className="block">
          <span className="text-gray-700 font-medium">Room Type</span>
          <select
            value={project.design.roomType}
            onChange={(e) => updateDesign('roomType', e.target.value)}
            className="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2"
          >
            <option>Dedicated Home Theater</option>
            <option>Living Room Integrated</option>
            <option>Media Room</option>
            <option>Outdoor Setup</option>
          </select>
        </label>

        {/* Seating Rows */}
        <label className="block">
          <span className="text-gray-700 font-medium">Seating Rows</span>
          <input
            type="number"
            min="1"
            value={project.design.seatingRows}
            onChange={(e) => updateDesign('seatingRows', parseInt(e.target.value) || 1)}
            className="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2"
          />
        </label>
      </div>

      {/* Dimensions */}
      <h4 className="text-lg font-semibold mt-4">Room Dimensions (Feet)</h4>
      <div className="grid grid-cols-3 gap-4">
        {['length', 'width', 'height'].map(dim => (
          <label key={dim} className="block">
            <span className="text-gray-700 font-medium capitalize">{dim}</span>
            <input
              type="number"
              min="1"
              value={project.design.roomDimensions[dim]}
              onChange={(e) => updateDesign('roomDimensions', { ...project.design.roomDimensions, [dim]: parseFloat(e.target.value) || 1 })}
              className="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2"
            />
          </label>
        ))}
      </div>

      {/* Speaker Layout */}
      <label className="block">
        <span className="text-gray-700 font-medium">Speaker Layout (e.g., 7.2.4)</span>
        <input
          type="text"
          value={project.design.speakerLayout}
          onChange={(e) => updateDesign('speakerLayout', e.target.value)}
          placeholder="e.g., 5.1.2, 7.2.4 Dolby Atmos"
          className="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2"
        />
      </label>

      {/* Design Notes */}
      <label className="block">
        <span className="text-gray-700 font-medium">Design & Acoustic Notes</span>
        <textarea
          value={project.design.notes}
          onChange={(e) => updateDesign('notes', e.target.value)}
          rows="4"
          placeholder="e.g., Target SPL, isolation requirements, subwoofer placement strategy..."
          className="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2"
        />
      </label>
    </Card>
  );
};

// 2. Equipment List (Bill of Materials)
const EquipmentTab = ({ project, dispatch }) => {
  const updateEquipment = (index, key, value) => {
    const updatedEquipment = [...project.equipment];
    updatedEquipment[index] = { ...updatedEquipment[index], [key]: value };
    dispatch({ type: 'UPDATE_CURRENT_PROJECT', payload: { ...project, equipment: updatedEquipment } });
  };

  const addEquipment = () => {
    dispatch({
      type: 'UPDATE_CURRENT_PROJECT',
      payload: {
        ...project,
        equipment: [...project.equipment, { name: '', model: '', clientPrice: 0, yourCost: 0, quantity: 1 }],
      },
    });
  };

  const removeEquipment = (index) => {
    const updatedEquipment = project.equipment.filter((_, i) => i !== index);
    dispatch({ type: 'UPDATE_CURRENT_PROJECT', payload: { ...project, equipment: updatedEquipment } });
  };

  const totals = project.equipment.reduce((acc, eq) => ({
    clientTotal: acc.clientTotal + (eq.clientPrice * eq.quantity),
    yourTotal: acc.yourTotal + (eq.yourCost * eq.quantity),
  }), { clientTotal: 0, yourTotal: 0 });

  return (
    <Card className="space-y-6">
      <h3 className="text-xl font-bold text-gray-800 flex items-center"><Monitor className="w-5 h-5 mr-2" /> Equipment List (BOM)</h3>
      <p className="text-sm text-gray-500">Track client prices (for markup calculation) and your wholesale/dealer cost (for profit tracking).</p>

      <div className="space-y-4 max-h-96 overflow-y-auto">
        {project.equipment.map((eq, index) => (
          <div key={index} className="border p-4 rounded-lg bg-gray-50 shadow-sm grid grid-cols-1 md:grid-cols-12 gap-3 items-end">
            <div className="col-span-12 text-sm font-semibold text-blue-600">Item #{index + 1}</div>
            
            {/* Name & Model */}
            <input
              type="text"
              placeholder="Name (e.g., AVR)"
              value={eq.name}
              onChange={(e) => updateEquipment(index, 'name', e.target.value)}
              className="col-span-12 md:col-span-3 rounded-md border-gray-300 p-2"
            />
            <input
              type="text"
              placeholder="Model/Part Number"
              value={eq.model}
              onChange={(e) => updateEquipment(index, 'model', e.target.value)}
              className="col-span-12 md:col-span-2 rounded-md border-gray-300 p-2"
            />

            {/* Prices & Qty */}
            <input
              type="number"
              min="0"
              placeholder="Client Price ($)"
              value={eq.clientPrice}
              onChange={(e) => updateEquipment(index, 'clientPrice', parseFloat(e.target.value) || 0)}
              className="col-span-6 md:col-span-2 rounded-md border-gray-300 p-2"
            />
            <input
              type="number"
              min="0"
              placeholder="Your Cost ($)"
              value={eq.yourCost}
              onChange={(e) => updateEquipment(index, 'yourCost', parseFloat(e.target.value) || 0)}
              className="col-span-6 md:col-span-2 rounded-md border-gray-300 p-2"
            />
            <input
              type="number"
              min="1"
              placeholder="Qty"
              value={eq.quantity}
              onChange={(e) => updateEquipment(index, 'quantity', parseInt(e.target.value) || 1)}
              className="col-span-6 md:col-span-2 rounded-md border-gray-300 p-2"
            />

            {/* Remove Button */}
            <div className="col-span-6 md:col-span-1">
              <Button onClick={() => removeEquipment(index)} variant="danger" icon={Trash2} className="w-full text-sm">
                Remove
              </Button>
            </div>
          </div>
        ))}
      </div>

      <Button onClick={addEquipment} icon={Plus} variant="secondary" className="w-full mt-4">
        Add Equipment Item
      </Button>

      <div className="mt-6 border-t pt-4 text-right">
        <p className="font-semibold text-lg">Total Client Equipment Value: ${totals.clientTotal.toFixed(2)}</p>
      </div>
    </Card>
  );
};

// 3. Financial & Markup Configuration
const FinancialTab = ({ project, dispatch, calculations }) => {
  const updateFinancials = (key, value) => {
    dispatch({
      type: 'UPDATE_CURRENT_PROJECT',
      payload: { ...project, financials: { ...project.financials, [key]: value } },
    });
  };

  const formatCurrency = (amount) => `$${(amount || 0).toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ",")}`;

  return (
    <Card className="space-y-6">
      <h3 className="text-xl font-bold text-gray-800 flex items-center"><DollarSign className="w-5 h-5 mr-2" /> Financial Configuration</h3>
      <p className="text-sm text-gray-500">Define your profit structure and subcontractor cost/markup.</p>

      {/* YOUR FEES (PROFIT) */}
      <div className="p-4 bg-blue-50 border-l-4 border-blue-600 rounded-lg">
        <h4 className="text-lg font-semibold text-blue-800 mb-3">Your Consulting & Management Fees</h4>
        <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
          <label className="block">
            <span className="text-gray-700 font-medium">Flat Design & Consulting Fee</span>
            <input
              type="number"
              min="0"
              value={project.financials.consultingFee}
              onChange={(e) => updateFinancials('consultingFee', parseFloat(e.target.value) || 0)}
              className="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2"
            />
          </label>
          <label className="block">
            <span className="text-gray-700 font-medium">Project Management Fee Rate (of Equipment Value)</span>
            <div className="flex items-center mt-1">
                <input
                    type="number"
                    min="0"
                    max="1"
                    step="0.01"
                    value={project.financials.managementFeeRate}
                    onChange={(e) => updateFinancials('managementFeeRate', parseFloat(e.target.value) || 0)}
                    className="block w-full rounded-l-md border-gray-300 shadow-sm p-2"
                />
                <span className="bg-gray-200 p-2 border border-gray-300 rounded-r-md">%</span>
            </div>
          </label>
        </div>
      </div>

      {/* SUBCONTRACTOR COSTS & MARKUP */}
      <div className="p-4 bg-gray-100 border-l-4 border-gray-400 rounded-lg">
        <h4 className="text-lg font-semibold text-gray-800 mb-3">Subcontractor Labor Costs (COGS) & Markup</h4>
        <div className="grid grid-cols-2 gap-4">
            <label className="block">
                <span className="text-gray-700 font-medium flex items-center"><HardHat className="w-4 h-4 mr-1" /> Installer Labor Cost (Your Cost Estimate)</span>
                <input
                    type="number"
                    min="0"
                    value={project.financials.subcontractorCost}
                    onChange={(e) => updateFinancials('subcontractorCost', parseFloat(e.target.value) || 0)}
                    className="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2"
                />
            </label>
            <label className="block">
                <span className="text-gray-700 font-medium">Installer Markup Rate</span>
                <div className="flex items-center mt-1">
                    <input
                        type="number"
                        min="0"
                        step="0.01"
                        value={project.financials.markupRateSubcontractor}
                        onChange={(e) => updateFinancials('markupRateSubcontractor', parseFloat(e.target.value) || 0)}
                        className="block w-full rounded-l-md border-gray-300 shadow-sm p-2"
                    />
                    <span className="bg-gray-200 p-2 border border-gray-300 rounded-r-md">%</span>
                </div>
            </label>
            <label className="block">
                <span className="text-gray-700 font-medium flex items-center"><Mic className="w-4 h-4 mr-1" /> Calibrator Service Cost (Your Cost Estimate)</span>
                <input
                    type="number"
                    min="0"
                    value={project.financials.calibratorCost}
                    onChange={(e) => updateFinancials('calibratorCost', parseFloat(e.target.value) || 0)}
                    className="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2"
                />
            </label>
            <label className="block">
                <span className="text-gray-700 font-medium">Calibrator Markup Rate</span>
                <div className="flex items-center mt-1">
                    <input
                        type="number"
                        min="0"
                        step="0.01"
                        value={project.financials.markupRateCalibrator}
                        onChange={(e) => updateFinancials('markupRateCalibrator', parseFloat(e.target.value) || 0)}
                        className="block w-full rounded-l-md border-gray-300 shadow-sm p-2"
                    />
                    <span className="bg-gray-200 p-2 border border-gray-300 rounded-r-md">%</span>
                </div>
            </label>
        </div>
      </div>

      {/* SUMMARY */}
      {calculations && (
        <div className="mt-8 pt-6 border-t-2 border-blue-600 space-y-3">
          <h4 className="text-xl font-bold text-blue-700">Financial Summary</h4>
          <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
            <SummaryStat title="Total Client Equipment Value" value={formatCurrency(calculations.eqCosts.clientTotal)} />
            <SummaryStat title="Your Estimated Gross Profit" value={formatCurrency(calculations.grossProfit)} isProfit={true} />
            <SummaryStat title="Total Client Invoice (Estimate)" value={formatCurrency(calculations.totalClientInvoice)} isLarge={true} />
          </div>
          
          <div className="grid grid-cols-2 sm:grid-cols-4 gap-4 pt-4 border-t">
            <SummaryStat title="Design Fee" value={formatCurrency(calculations.designFee)} />
            <SummaryStat title="Management Fee" value={formatCurrency(calculations.projectManagementFee)} />
            <SummaryStat title="Total Subcontractor Markup" value={formatCurrency(calculations.totalMarkup)} />
            <SummaryStat title="Total Subcontractor Bill (Client)" value={formatCurrency(calculations.totalSubcontractorBill)} />
          </div>
        </div>
      )}
    </Card>
  );
};

const SummaryStat = ({ title, value, isProfit = false, isLarge = false }) => (
  <div className={`p-3 rounded-lg shadow-sm ${isProfit ? 'bg-green-50' : isLarge ? 'bg-blue-100' : 'bg-gray-50'}`}>
    <p className={`text-xs uppercase font-medium ${isProfit ? 'text-green-700' : isLarge ? 'text-blue-700' : 'text-gray-500'}`}>{title}</p>
    <p className={`text-xl font-bold ${isLarge ? 'text-2xl text-blue-900' : isProfit ? 'text-green-900' : 'text-gray-900'}`}>{value}</p>
  </div>
);

// 4. Subcontractor Work Specifications
const SpecsTab = ({ project, dispatch }) => {
    const updateSpecs = (key, subKey, value) => {
        dispatch({
            type: 'UPDATE_CURRENT_PROJECT',
            payload: { ...project, workSpecs: { ...project.workSpecs, [key]: { ...project.workSpecs[key], [subKey]: value } } },
        });
    };

    return (
        <Card className="space-y-6">
            <h3 className="text-xl font-bold text-gray-800 flex items-center"><ClipboardList className="w-5 h-5 mr-2" /> Subcontractor Work Specifications</h3>
            <p className="text-sm text-gray-500">Generate clear, separate work orders for your licensed partners.</p>

            {/* Installer/Contractor Specs */}
            <div className="p-4 border-l-4 border-yellow-500 bg-yellow-50 rounded-lg">
                <h4 className="text-lg font-semibold text-yellow-800 flex items-center"><HardHat className="w-5 h-5 mr-2" /> Licensed Installer/Contractor Work Order</h4>
                <label className="block mt-4">
                    <span className="text-gray-700 font-medium">Specific Tasks (What to do)</span>
                    <textarea
                        value={project.workSpecs.contractor.tasks}
                        onChange={(e) => updateSpecs('contractor', 'tasks', e.target.value)}
                        rows="4"
                        placeholder="e.g., Run all speaker wires to specified locations; install low-voltage boxes; install TV mounting bracket."
                        className="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2"
                    />
                </label>
                <label className="block mt-4">
                    <span className="text-gray-700 font-medium">Requirements & Notes (How to do it)</span>
                    <textarea
                        value={project.workSpecs.contractor.requirements}
                        onChange={(e) => updateSpecs('contractor', 'requirements', e.target.value)}
                        rows="3"
                        placeholder="e.g., Use CL2/CL3 rated cable; take photos of rough-in before drywall patch; use fire-rated caulk."
                        className="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2"
                    />
                </label>
            </div>

            {/* Calibrator Specs */}
            <div className="p-4 border-l-4 border-purple-500 bg-purple-50 rounded-lg">
                <h4 className="text-lg font-semibold text-purple-800 flex items-center"><Zap className="w-5 h-5 mr-2" /> Specialized Calibrator Work Order</h4>
                <label className="block mt-4">
                    <span className="text-gray-700 font-medium">Specific Tasks (What to do)</span>
                    <textarea
                        value={project.workSpecs.calibrator.tasks}
                        onChange={(e) => updateSpecs('calibrator', 'tasks', e.target.value)}
                        rows="4"
                        placeholder="e.g., Full Audio Calibration (REW analysis); Video Calibration (SDR/HDR/DV modes) on TV/Projector."
                        className="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2"
                    />
                </label>
                <label className="block mt-4">
                    <span className="text-gray-700 font-medium">Requirements & Notes (How to do it)</span>
                    <textarea
                        value={project.workSpecs.calibrator.requirements}
                        onChange={(e) => updateSpecs('calibrator', 'requirements', e.target.value)}
                        rows="3"
                        placeholder="e.g., Provide digital pre/post calibration report; verify subwoofer phase alignment."
                        className="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2"
                    />
                </label>
            </div>
        </Card>
    );
};

// 5. AI Assistant Tab (NEW)

const AIAssistantTab = ({ project, dispatch, state }) => {
    const { isAILoading, aiResponse } = state;
    const { design } = project;

    const generateRecommendation = async () => {
        dispatch({ type: 'SET_AI_LOADING', payload: true });
        dispatch({ type: 'SET_AI_RESPONSE', payload: null });

        const roomQuery = `Room Type: ${design.roomType}, Dimensions: ${design.roomDimensions.length}x${design.roomDimensions.width}x${design.roomDimensions.height} ft, Seating Rows: ${design.seatingRows}. Notes: ${design.notes}`;

        const userQuery = `Based on the following room specifications and aiming for a high-performance home theater: ${roomQuery}. 
        Provide a detailed speaker configuration recommendation (e.g., 7.2.4 or 5.1.4) and recommend 5 key equipment components (AV Receiver, Front Speakers, Subwoofer, Projector/TV, and Screen/Display) that fit a mid-to-high-end budget. 
        Format the response in Markdown with clear headings for 'Recommended Configuration' and 'Equipment Recommendations (Model/Why)'.`;

        const systemPrompt = "You are a world-class, unbiased home theater and acoustic design expert. Provide highly practical, detailed, and up-to-date recommendations. Use Google Search to ensure equipment recommendations are current and relevant.";
        
        const apiKey = ""; 
        const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;

        // API call logic with exponential backoff
        let maxRetries = 3;
        let delay = 1000;
        let responseJson = null;

        for (let attempt = 0; attempt < maxRetries; attempt++) {
            try {
                const payload = {
                    contents: [{ parts: [{ text: userQuery }] }],
                    tools: [{ "google_search": {} }],
                    systemInstruction: { parts: [{ text: systemPrompt }] },
                };

                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                responseJson = await response.json();
                break; // Success
            } catch (error) {
                console.warn(`Attempt ${attempt + 1} failed. Retrying in ${delay}ms.`);
                if (attempt < maxRetries - 1) {
                    await new Promise(resolve => setTimeout(resolve, delay));
                    delay *= 2;
                } else {
                    console.error("Failed to fetch AI recommendation after multiple retries.");
                    dispatch({ type: 'SET_AI_RESPONSE', payload: { text: "Error: Failed to connect to AI service. Please check the network and try again.", sources: [] } });
                }
            }
        }

        dispatch({ type: 'SET_AI_LOADING', payload: false });

        if (responseJson && responseJson.candidates?.[0]?.content?.parts?.[0]?.text) {
            const text = responseJson.candidates[0].content.parts[0].text;
            let sources = [];
            const groundingMetadata = responseJson.candidates[0].groundingMetadata;

            if (groundingMetadata && groundingMetadata.groundingAttributions) {
                sources = groundingMetadata.groundingAttributions
                    .map(attribution => ({
                        uri: attribution.web?.uri,
                        title: attribution.web?.title,
                    }))
                    .filter(source => source.uri && source.title);
            }
            dispatch({ type: 'SET_AI_RESPONSE', payload: { text, sources } });
        } else if (!isAILoading) {
            dispatch({ type: 'SET_AI_RESPONSE', payload: { text: "No recommendation could be generated. Check your input and try again.", sources: [] } });
        }
    };
    
    // Minimal Markdown rendering for clean display
    const renderMarkdown = (markdownText) => {
        if (!markdownText) return null;
        const processedLines = markdownText
            .split('\n')
            .map((line, index) => {
                const key = index;
                // Strong/Bold
                line = line.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
                
                // Headings
                if (line.startsWith('###')) return <h3 key={key} className="text-lg font-bold mt-4 mb-2 text-blue-800">{line.substring(3).trim()}</h3>;
                if (line.startsWith('##')) return <h2 key={key} className="text-xl font-bold mt-4 mb-2 text-blue-700">{line.substring(2).trim()}</h2>;
                
                // List Items
                if (line.startsWith('* ')) return <li key={key} className="ml-6 list-disc">{line.substring(2).trim()}</li>;
                
                // Paragraphs (if not empty)
                return line.trim() ? <p key={key} className="mb-2">{line}</p> : null;
            }).filter(Boolean); // Filter out nulls from empty lines
        
        return <div dangerouslySetInnerHTML={{ __html: processedLines.map(el => {
            // Need to flatten React elements to strings for innerHTML
            if (typeof el === 'object' && el.props.dangerouslySetInnerHTML) {
                return el.props.dangerouslySetInnerHTML.__html;
            }
            return new XMLSerializer().serializeToString(el);
        }).join('')}} />;
    };
    

    return (
        <Card className="space-y-6">
            <h3 className="text-xl font-bold text-gray-800 flex items-center">
                <Lightbulb className="w-5 h-5 mr-2 text-yellow-500" /> AI Design Assistant
            </h3>
            <p className="text-sm text-gray-500">Generate unbiased speaker layouts and equipment recommendations based on the current room specs. **Ensure your room dimensions are accurate in the Design tab before running.**</p>
            
            <Button 
                onClick={generateRecommendation} 
                icon={isAILoading ? Loader2 : Zap} 
                disabled={isAILoading} 
                className={isAILoading ? 'animate-spin-slow w-full' : 'w-full'}
                variant="success"
            >
                {isAILoading ? 'Generating Recommendations...' : 'Generate Design & Equipment Recs'}
            </Button>

            {isAILoading && (
                <div className="text-center p-4 text-sm text-blue-600 flex items-center justify-center space-x-2">
                    <Loader2 className="w-5 h-5 animate-spin" />
                    <span>AI is analyzing acoustic space and searching for current market equipment...</span>
                </div>
            )}

            {aiResponse && (
                <div className="mt-6 border-t pt-4">
                    <h4 className="text-lg font-bold text-gray-800 mb-4">AI Recommendation</h4>
                    <div className="p-4 bg-gray-50 rounded-lg text-sm space-y-3">
                        <div dangerouslySetInnerHTML={{ __html: aiResponse.text.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>').replace(/\n/g, '<br/>') }} />
                    </div>
                    
                    {aiResponse.sources && aiResponse.sources.length > 0 && (
                        <div className="mt-4 pt-4 border-t border-gray-200">
                            <p className="font-semibold text-xs uppercase text-gray-500 mb-2">Sources:</p>
                            <ul className="list-disc ml-5 text-xs text-gray-600 space-y-1">
                                {aiResponse.sources.map((source, index) => (
                                    <li key={index}>
                                        <a href={source.uri} target="_blank" rel="noopener noreferrer" className="text-blue-500 hover:underline">
                                            {source.title || source.uri}
                                        </a>
                                    </li>
                                ))}
                            </ul>
                        </div>
                    )}
                </div>
            )}
        </Card>
    );
};


// 6. Deliverables & Reports (Read-only/Printable View)

const DeliverablesTab = ({ project, calculations }) => {
    if (!calculations) return <Card>Recalculate financials before viewing deliverables.</Card>;

    const renderEquipmentList = () => (
        <div className="p-6 border border-gray-200 rounded-lg mb-6 break-before-page print:border-none">
            <h4 className="text-lg font-bold mb-4 flex items-center text-blue-700"><Monitor className="w-5 h-5 mr-2" /> Recommended Equipment & Cost Breakdown</h4>
            <table className="min-w-full divide-y divide-gray-200">
                <thead>
                    <tr className="bg-gray-50 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                        <th className="px-3 py-2">Item</th>
                        <th className="px-3 py-2">Model</th>
                        <th className="px-3 py-2 text-right">Qty</th>
                        <th className="px-3 py-2 text-right">Unit Price</th>
                        <th className="px-3 py-2 text-right">Total Client Cost</th>
                    </tr>
                </thead>
                <tbody className="divide-y divide-gray-200">
                    {project.equipment.map((eq, index) => (
                        <tr key={index} className="text-sm">
                            <td className="px-3 py-2 font-medium text-gray-900">{eq.name}</td>
                            <td className="px-3 py-2 text-gray-500">{eq.model}</td>
                            <td className="px-3 py-2 text-right">{eq.quantity}</td>
                            <td className="px-3 py-2 text-right">${eq.clientPrice.toFixed(2)}</td>
                            <td className="px-3 py-2 text-right font-semibold">${(eq.clientPrice * eq.quantity).toFixed(2)}</td>
                        </tr>
                    ))}
                    <tr className="bg-gray-100 font-bold">
                        <td colSpan="4" className="px-3 py-2 text-right">Equipment Subtotal</td>
                        <td className="px-3 py-2 text-right">${calculations.eqCosts.clientTotal.toFixed(2)}</td>
                    </tr>
                </tbody>
            </table>
        </div>
    );

    const renderInvoice = () => (
        <div className="p-6 border border-gray-200 rounded-lg mb-6 break-before-page print:border-none">
            <h4 className="text-lg font-bold mb-4 flex items-center text-green-700"><DollarSign className="w-5 h-5 mr-2" /> Project Invoice Summary</h4>
            <div className="space-y-2">
                <div className="flex justify-between border-b pb-1">
                    <span className="font-semibold">A. Equipment Value (Passed Through)</span>
                    <span>${calculations.eqCosts.clientTotal.toFixed(2)}</span>
                </div>

                <div className="pt-2">
                    <h5 className="font-bold text-md mb-1 text-blue-800">B. Consultant & Management Fees (Your Services)</h5>
                    <div className="flex justify-between ml-4">
                        <span>Design & Consulting Fee (Flat)</span>
                        <span>${calculations.designFee.toFixed(2)}</span>
                    </div>
                    <div className="flex justify-between ml-4">
                        <span>Project Management Fee ({project.financials.managementFeeRate * 100}%)</span>
                        <span>${calculations.projectManagementFee.toFixed(2)}</span>
                    </div>
                </div>

                <div className="pt-2">
                    <h5 className="font-bold text-md mb-1 text-blue-800">C. Subcontractor Work (Coordinated Labor)</h5>
                    <div className="flex justify-between ml-4">
                        <span>Licensed Installer Work Order (Incl. Markup)</span>
                        <span>${(project.financials.subcontractorCost + calculations.installerMarkup).toFixed(2)}</span>
                    </div>
                    <div className="flex justify-between ml-4">
                        <span>Certified Calibration Service (Incl. Markup)</span>
                        <span>${(project.financialorCost + calculations.calibratorMarkup).toFixed(2)}</span>
                    </div>
                </div>

                <div className="flex justify-between border-t-2 border-blue-600 pt-3 text-2xl font-extrabold text-blue-900">
                    <span>TOTAL PROJECT INVESTMENT</span>
                    <span>{calculations.totalClientInvoice.toFixed(2)}</span>
                </div>
            </div>
        </div>
    );

    return (
        <Card className="space-y-6">
            <h3 className="text-xl font-bold text-gray-800 flex items-center"><FileText className="w-5 h-5 mr-2" /> Deliverables & Reports</h3>

            <Button onClick={() => window.print()} variant="primary" className="w-full print:hidden" icon={Eye}>
                Print/Export All Deliverables (Optimized for Print View)
            </Button>

            <div className="p-4 bg-gray-50 rounded-lg text-sm italic">
                <p>The print view includes: Design Summary, Equipment List, Work Orders, and Final Invoice.</p>
                <p>Use your browser's print function to save as a PDF for client delivery.</p>
            </div>
            
            <div className="print-area">
                <div className="p-6 border border-gray-200 rounded-lg mb-6 break-before-page print:border-none">
                    <h4 className="text-lg font-bold mb-4 flex items-center text-blue-700"><Settings className="w-5 h-5 mr-2" /> Design & Project Summary</h4>
                    <p><strong>Project Name:</strong> {project.name}</p>
                    <p><strong>Room Type:</strong> {project.design.roomType}</p>
                    <p><strong>Dimensions:</strong> {project.design.roomDimensions.length}' x {project.design.roomDimensions.width}' x {project.design.roomDimensions.height}'</p>
                    <p><strong>Speaker Layout:</strong> {project.design.speakerLayout}</p>
                    <p className="mt-2"><strong>Acoustic Notes:</strong> {project.design.notes}</p>
                </div>
                {renderEquipmentList()}

                <div className="p-6 border border-gray-200 rounded-lg mb-6 break-before-page print:border-none">
                    <h4 className="text-lg font-bold mb-4 flex items-center text-yellow-700"><HardHat className="w-5 h-5 mr-2" /> Work Order: Licensed Installer</h4>
                    <p><strong>Tasks:</strong> {project.workSpecs.contractor.tasks}</p>
                    <p className="mt-2"><strong>Requirements:</strong> {project.workSpecs.contractor.requirements}</p>
                </div>

                <div className="p-6 border border-gray-200 rounded-lg mb-6 break-before-page print:border-none">
                    <h4 className="text-lg font-bold mb-4 flex items-center text-purple-700"><Zap className="w-5 h-5 mr-2" /> Work Order: Certified Calibrator</h4>
                    <p><strong>Tasks:</strong> {project.workSpecs.calibrator.tasks}</p>
                    <p className="mt-2"><strong>Requirements:</strong> {project.workSpecs.calibrator.requirements}</p>
                </div>

                {renderInvoice()}
            </div>
        </Card>
    );
};

// --- MAIN PROJECT EDITOR VIEW ---

const ProjectEditor = ({ state, dispatch, saveProject, deleteProject }) => {
  const { currentProject, activeTab, isLoading, userId } = state;
  if (!currentProject) return null;

  const calculations = calculateFinancials(currentProject);

  const TABS = [
    { id: 'Design', name: 'Design & Room Specs', icon: LayoutGrid, component: DesignTab },
    { id: 'Equipment', name: 'Equipment List (BOM)', icon: Monitor, component: EquipmentTab },
    { id: 'Financials', name: 'Finance & Markup', icon: DollarSign, component: FinancialTab, props: { calculations } },
    { id: 'Specs', name: 'Subcontractor Specs', icon: ClipboardList, component: SpecsTab },
    { id: 'AI', name: 'AI Assistant', icon: Lightbulb, component: AIAssistantTab, props: { state } }, // NEW TAB
    { id: 'Deliverables', name: 'Reports & Invoice', icon: FileText, component: DeliverablesTab, props: { calculations } },
  ];

  const ActiveComponent = TABS.find(t => t.id === activeTab).component;
  const ActiveProps = TABS.find(t => t.id === activeTab).props || {};

  const handleSave = () => {
    saveProject(currentProject, userId, dispatch);
  };

  const handleDelete = () => {
    if (window.confirm(`Are you sure you want to delete project: ${currentProject.name}?`)) {
        deleteProject(currentProject.id, userId, dispatch);
    }
  };

  return (
    <div className="w-full max-w-7xl mx-auto p-4 md:p-8">
      <div className="flex justify-between items-center mb-6 border-b pb-4">
        <div className="flex items-center space-x-4">
            <Button onClick={() => dispatch({ type: 'SET_CURRENT_PROJECT', payload: null })} variant="ghost" className="text-lg">
                <ChevronDown className="w-5 h-5 rotate-90 mr-2" />
                Back to Projects
            </Button>
            <input
                type="text"
                value={currentProject.name}
                onChange={(e) => dispatch({ type: 'UPDATE_CURRENT_PROJECT', payload: { ...currentProject, name: e.target.value } })}
                className="text-2xl font-extrabold p-1 border-b-2 border-gray-200 focus:border-blue-500 transition duration-150"
            />
        </div>
        
        <div className="flex space-x-2">
            <Button onClick={handleDelete} variant="danger" icon={Trash2} disabled={isLoading}>
                Delete Project
            </Button>
            <Button onClick={handleSave} variant="primary" icon={isLoading ? Loader2 : Save} disabled={isLoading} className={isLoading ? 'animate-pulse' : ''}>
                {isLoading ? 'Saving...' : 'Save Changes'}
            </Button>
        </div>
      </div>

      {/* Tabs Navigation */}
      <div className="flex space-x-1 mb-6 overflow-x-auto border-b">
        {TABS.map((tab) => (
          <button
            key={tab.id}
            onClick={() => dispatch({ type: 'SET_ACTIVE_TAB', payload: tab.id })}
            className={`flex items-center px-4 py-2 font-semibold transition-all duration-200 rounded-t-lg
              ${activeTab === tab.id
                ? 'bg-white border-b-4 border-blue-600 text-blue-600 shadow-sm'
                : 'text-gray-600 hover:bg-gray-50 border-b-4 border-transparent'
              }`}
          >
            <tab.icon className="w-5 h-5 mr-2" />
            {tab.name}
          </button>
        ))}
      </div>

      {/* Active Tab Content */}
      <ActiveComponent project={currentProject} dispatch={dispatch} {...ActiveProps} />
    </div>
  );
};

// --- MAIN PROJECT LIST VIEW ---

const ProjectList = ({ state, dispatch, saveProject }) => {
  const { projects, userId, isLoading } = state;

  const handleCreateNew = () => {
    const newProject = { ...projectTemplate, id: Date.now().toString() }; // Use Date.now() as a temporary ID
    dispatch({ type: 'SET_CURRENT_PROJECT', payload: newProject });
  };
  
  const totalProjects = projects.length;

  return (
    <div className="w-full max-w-5xl mx-auto p-4 md:p-8">
      <div className="flex justify-between items-center mb-8 border-b pb-4">
        <h1 className="text-3xl font-extrabold text-gray-800 flex items-center">
            <Home className="w-6 h-6 mr-3" />
            AV Project Dashboard ({totalProjects})
        </h1>
        <Button onClick={handleCreateNew} icon={Plus} variant="success">
          Create New Project
        </Button>
      </div>
      
      {isLoading && totalProjects === 0 && (
          <div className="text-center p-8 text-lg text-gray-500 flex justify-center items-center">
              <Loader2 className="w-6 h-6 mr-2 animate-spin" />
              Loading projects...
          </div>
      )}

      <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
        {projects.map(project => {
          const totals = calculateFinancials(project);
          const projectStatusColor = project.status === 'Design Phase' ? 'bg-blue-100 text-blue-800' : 'bg-green-100 text-green-800';

          return (
            <Card key={project.id} className="cursor-pointer hover:shadow-2xl transition duration-300 border-l-4 border-blue-500" onClick={() => dispatch({ type: 'SET_CURRENT_PROJECT', payload: project })}>
              <div className="flex justify-between items-start">
                <h2 className="text-xl font-bold text-gray-900">{project.name}</h2>
                <span className={`text-xs font-semibold px-2 py-1 rounded-full ${projectStatusColor}`}>
                  {project.status}
                </span>
              </div>
              
              <div className="mt-4 space-y-2 text-sm">
                <p className="text-gray-600"><strong>Room:</strong> {project.design.roomDimensions.length}' x {project.design.roomDimensions.width}' ({project.design.roomType})</p>
                <p className="text-gray-600"><strong>Layout:</strong> {project.design.speakerLayout}</p>
              </div>

              {totals && (
                <div className="mt-4 pt-4 border-t">
                  <p className="font-semibold text-base text-gray-700">Client Invoice Estimate:</p>
                  <p className="text-2xl font-extrabold text-blue-600">${totals.totalClientInvoice.toFixed(2)}</p>
                  <p className="text-sm text-green-600">Gross Profit Estimate: ${totals.grossProfit.toFixed(2)}</p>
                </div>
              )}
              
            </Card>
          );
        })}
        {totalProjects === 0 && !isLoading && (
            <Card className="text-center col-span-2 p-10 text-gray-500">
                <Monitor className="w-10 h-10 mx-auto mb-4" />
                <p className="text-lg font-semibold">No Projects Found.</p>
                <p>Click "Create New Project" to get started.</p>
            </Card>
        )}
      </div>
    </div>
  );
};

// --- APP COMPONENT ---

const App = () => {
  const [state, dispatch] = useReducer(appReducer, initialState);
  const { isAuthReady, isAuthenticated, userId, currentProject } = state;

  // 1. Authentication Effect
  useEffect(() => {
    if (!auth) {
        console.error("Firebase Auth not initialized.");
        dispatch({ type: 'SET_AUTH_STATE', payload: { userId: 'anonymous', isAuthenticated: false, isAuthReady: true } });
        return;
    }

    const signIn = async () => {
        try {
            if (initialAuthToken) {
                await signInWithCustomToken(auth, initialAuthToken);
            } else {
                await signInAnonymously(auth);
            }
        } catch (error) {
            console.error("Firebase Sign-In Error:", error);
        }
    };

    signIn();

    const unsubscribe = onAuthStateChanged(auth, (user) => {
      if (user) {
        dispatch({ type: 'SET_AUTH_STATE', payload: { userId: user.uid, isAuthenticated: true, isAuthReady: true } });
        console.log("Authenticated with user ID:", user.uid);
      } else {
        dispatch({ type: 'SET_AUTH_STATE', payload: { userId: null, isAuthenticated: false, isAuthReady: true } });
        console.log("No user signed in. Ready.");
      }
    });

    return () => unsubscribe();
  }, []);

  // 2. Data Subscription Effect (Runs after Auth is Ready)
  useEffect(() => {
    if (!isAuthReady || !userId || !db) return;

    const projectsColRef = collection(db, 'artifacts', appId, 'users', userId, 'av_projects');
    
    // Listen for real-time changes
    const unsubscribe = onSnapshot(projectsColRef, (snapshot) => {
      const projectsData = snapshot.docs.map(doc => ({
        id: doc.id,
        ...doc.data(),
      }));
      dispatch({ type: 'SET_PROJECTS', payload: projectsData });
    }, (error) => {
        console.error("Firestore Snapshot Error:", error);
    });

    return () => unsubscribe();
  }, [isAuthReady, userId]);

  // Handle saving and deleting project via the dispatched functions
  const saveProjectWrapper = useCallback((project, uid, disp) => saveProjectToFirestore(project, uid, disp), []);
  const deleteProjectWrapper = useCallback((pid, uid, disp) => deleteProjectFromFirestore(pid, uid, disp), []);

  if (!isAuthReady) {
    return (
      <div className="flex items-center justify-center min-h-screen bg-gray-50 text-gray-600">
        <Loader2 className="w-8 h-8 mr-3 animate-spin" />
        Authenticating and Loading System...
      </div>
    );
  }

  return (
    <div className="min-h-screen bg-gray-50 font-sans antialiased">
      <header className="bg-white shadow-sm border-b">
        <div className="max-w-7xl mx-auto py-3 px-4 sm:px-6 lg:px-8 flex justify-between items-center">
            <h1 className="text-xl font-bold text-blue-700">AV Project Manager</h1>
            <span className="text-sm text-gray-500">User ID: {userId}</span>
        </div>
      </header>

      <main className="pb-12">
        {currentProject ? (
          <ProjectEditor 
            state={state} 
            dispatch={dispatch} 
            saveProject={saveProjectWrapper} 
            deleteProject={deleteProjectWrapper}
          />
        ) : (
          <ProjectList 
            state={state} 
            dispatch={dispatch} 
            saveProject={saveProjectWrapper}
          />
        )}
      </main>
      
      {/* Print-specific CSS */}
      <style>{`
        @media print {
            body {
                margin: 0;
                padding: 0;
            }
            .print-area {
                width: 100%;
                margin: 0;
                padding: 0;
                box-shadow: none;
            }
            /* Hide everything not in the main content or print area */
            body > *:not(.print-area):not(.print-container) {
                display: none;
            }
            .print:hidden, header, footer, nav, button, .border-b, .mb-6 {
                display: none !important;
            }
            .break-before-page {
                page-break-before: always;
            }
            .print-area > div {
                box-shadow: none !important;
                border: 1px solid #ccc !important;
            }
        }
      `}</style>
    </div>
  );
};

export default App;
